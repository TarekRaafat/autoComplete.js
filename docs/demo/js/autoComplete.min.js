(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
  typeof define === 'function' && define.amd ? define(factory) :
  (global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.autoComplete = factory());
})(this, (function () { 'use strict';

  function _extends$3(){_extends$3=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target};return _extends$3.apply(this,arguments)}const select$1=element=>typeof element==="string"?document.querySelector(element):element();const create=(tag,options)=>{const el=typeof tag==="string"?document.createElement(tag):tag;for(const key in options){const val=options[key];if(key==="inside"){val.append(el);}else if(key==="dest"){select$1(val[0]).insertAdjacentElement(val[1],el);}else if(key==="around"){const ref=val;ref.parentNode.insertBefore(el,ref);el.append(ref);if(ref.getAttribute("autofocus")!=null)ref.focus();}else if(key in el){el[key]=val;}else {el.setAttribute(key,val);}}return el};const getQuery=field=>field instanceof HTMLInputElement||field instanceof HTMLTextAreaElement?field.value:field.innerHTML;const format=(value,diacritics)=>{value=String(value).toLowerCase();return diacritics?value.normalize("NFD").replace(/[\u0300-\u036f]/g,"").normalize("NFC"):value};const debounce=(callback,duration)=>{let timer;return ()=>{clearTimeout(timer);timer=setTimeout(()=>callback(),duration);}};const checkTrigger=(query,condition,threshold)=>condition?condition(query):query.length>=threshold;const mark=(value,cls)=>create("mark",_extends$3({innerHTML:value},typeof cls==="string"&&{class:cls})).outerHTML;

  var configure = (ctx=>{const{name,options,resultsList,resultItem}=ctx;for(const option in options){if(typeof options[option]==="object"){if(!ctx[option])ctx[option]={};for(const subOption in options[option]){ctx[option][subOption]=options[option][subOption];}}else {ctx[option]=options[option];}}ctx.selector=ctx.selector||"#"+name;resultsList.destination=resultsList.destination||ctx.selector;resultsList.id=resultsList.id||name+"_list_"+ctx.id;resultItem.id=resultItem.id||name+"_result";ctx.input=select$1(ctx.selector);});

  var eventEmitter = ((name,ctx)=>{ctx.input.dispatchEvent(new CustomEvent(name,{bubbles:true,detail:ctx.feedback,cancelable:true}));});

  var search = ((query,record,options)=>{const{mode,diacritics,highlight}=options||{};const nRecord=format(record,diacritics);record=String(record);query=format(query,diacritics);if(mode==="loose"){query=query.replace(/ /g,"");const qLength=query.length;let cursor=0;const match=Array.from(record).map((character,index)=>{if(cursor<qLength&&nRecord[index]===query[cursor]){character=highlight?mark(character,highlight):character;cursor++;}return character}).join("");if(cursor===qLength)return match}else {let match=nRecord.indexOf(query);if(~match){query=record.substring(match,match+query.length);match=highlight?record.replace(query,mark(query,highlight)):record;return match}}});

  function asyncGeneratorStep$2(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return}if(info.done){resolve(value);}else {Promise.resolve(value).then(_next,_throw);}}function _async_to_generator$2(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep$2(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep$2(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);})}}const getData=(ctx,query)=>_async_to_generator$2(function*(){const{data}=ctx;if(data.cache&&data.store)return;ctx.feedback=data.store=typeof data.src==="function"?yield data.src(query):data.src;eventEmitter("response",ctx);})();const findMatches=(query,ctx)=>{const{data,searchEngine}=ctx;let matches=[];data.store.forEach((value,index)=>{const find=key=>{const record=key?value[key]:value;const match=typeof searchEngine==="function"?searchEngine(query,record):search(query,record,{mode:searchEngine,diacritics:ctx.diacritics,highlight:ctx.resultItem.highlight});if(!match)return;let result={match,value};if(key)result.key=key;matches.push(result);};if(data.keys){for(const key of data.keys){find(key);}}else {find();}});if(data.filter)matches=data.filter(matches);const results=matches.slice(0,ctx.resultsList.maxResults);ctx.feedback={query,matches,results};eventEmitter("results",ctx);};

  function _extends$2(){_extends$2=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target};return _extends$2.apply(this,arguments)}const Expand="aria-expanded";const Active="aria-activedescendant";const Selected="aria-selected";const feedback=(ctx,index)=>{ctx.feedback.selection=_extends$2({index},ctx.feedback.results[index]);};const render=ctx=>{const{resultsList,list,resultItem,feedback}=ctx;const{matches,results}=feedback;ctx.cursor=-1;list.innerHTML="";if(matches.length||resultsList.noResults){const fragment=new DocumentFragment;results.forEach((result,index)=>{const element=create(resultItem.tag,_extends$2({id:`${resultItem.id}_${index}`,role:"option",innerHTML:result.match,inside:fragment},resultItem.class&&{class:resultItem.class}));if(resultItem.element)resultItem.element(element,result);});list.append(fragment);if(resultsList.element)resultsList.element(list,feedback);open(ctx);}else {close(ctx);}};const open=ctx=>{if(ctx.isOpen)return;(ctx.wrapper||ctx.input).setAttribute(Expand,true);ctx.list.removeAttribute("hidden");ctx.isOpen=true;eventEmitter("open",ctx);};const close=ctx=>{if(!ctx.isOpen)return;(ctx.wrapper||ctx.input).setAttribute(Expand,false);ctx.input.setAttribute(Active,"");ctx.list.setAttribute("hidden","");ctx.isOpen=false;eventEmitter("close",ctx);};const goTo=(index,ctx)=>{const{resultItem}=ctx;const results=ctx.list.getElementsByTagName(resultItem.tag);const cls=resultItem.selected?resultItem.selected.split(" "):false;if(ctx.isOpen&&results.length){const state=ctx.cursor;if(index>=results.length)index=0;if(index<0)index=results.length-1;ctx.cursor=index;if(state>-1){results[state].removeAttribute(Selected);if(cls)results[state].classList.remove(...cls);}results[index].setAttribute(Selected,true);if(cls)results[index].classList.add(...cls);ctx.input.setAttribute(Active,results[ctx.cursor].id);ctx.list.scrollTop=results[index].offsetTop-ctx.list.clientHeight+results[index].clientHeight+5;ctx.feedback.cursor=ctx.cursor;feedback(ctx,index);eventEmitter("navigate",ctx);}};const next=ctx=>{goTo(ctx.cursor+1,ctx);};const previous=ctx=>{goTo(ctx.cursor-1,ctx);};const select=(ctx,event,index)=>{index=index>=0?index:ctx.cursor;if(index<0)return;ctx.feedback.event=event;feedback(ctx,index);eventEmitter("selection",ctx);close(ctx);};const click=(event,ctx)=>{const itemTag=ctx.resultItem.tag.toUpperCase();const items=Array.from(ctx.list.querySelectorAll(itemTag));const item=event.target.closest(itemTag);if(item&&item.nodeName===itemTag){select(ctx,event,items.indexOf(item));}};const navigate=(event,ctx)=>{switch(event.keyCode){case 40:case 38:event.preventDefault();event.keyCode===40?next(ctx):previous(ctx);break;case 13:if(!ctx.submit)event.preventDefault();if(ctx.cursor>=0)select(ctx,event);break;case 9:if(ctx.resultsList.tabSelect&&ctx.cursor>=0)select(ctx,event);break;case 27:ctx.input.value="";eventEmitter("clear",ctx);close(ctx);break}};

  function asyncGeneratorStep$1(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return}if(info.done){resolve(value);}else {Promise.resolve(value).then(_next,_throw);}}function _async_to_generator$1(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep$1(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep$1(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);})}}function start(ctx,q){return _async_to_generator$1(function*(){let queryVal=q||getQuery(ctx.input);queryVal=ctx.query?ctx.query(queryVal):queryVal;const condition=checkTrigger(queryVal,ctx.trigger,ctx.threshold);if(condition){yield getData(ctx,queryVal);if(ctx.feedback instanceof Error)return;findMatches(queryVal,ctx);if(ctx.resultsList)render(ctx);}else {close(ctx);}})()}

  function _extends$1(){_extends$1=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target};return _extends$1.apply(this,arguments)}const eventsManager=(events,callback)=>{for(const element in events){for(const event in events[element]){callback(element,event);}}};const addEvents=ctx=>{const{events}=ctx;const run=debounce(()=>start(ctx),ctx.debounce);const publicEvents=ctx.events=_extends$1({input:_extends$1({},events&&events.input)},ctx.resultsList&&{list:events?_extends$1({},events.list):{}});const privateEvents={input:{input(){run();},keydown(event){navigate(event,ctx);},blur(){close(ctx);}},list:{mousedown(event){event.preventDefault();},click(event){click(event,ctx);}}};eventsManager(privateEvents,(element,event)=>{if(!ctx.resultsList&&event!=="input")return;if(publicEvents[element][event])return;publicEvents[element][event]=privateEvents[element][event];});eventsManager(publicEvents,(element,event)=>{ctx[element].addEventListener(event,publicEvents[element][event]);});};const removeEvents=ctx=>{eventsManager(ctx.events,(element,event)=>{ctx[element].removeEventListener(event,ctx.events[element][event]);});};

  function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return}if(info.done){resolve(value);}else {Promise.resolve(value).then(_next,_throw);}}function _async_to_generator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);})}}function _extends(){_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target};return _extends.apply(this,arguments)}function init(ctx){return _async_to_generator(function*(){const{placeHolder,resultsList}=ctx;const parentAttrs={role:"combobox","aria-owns":resultsList.id,"aria-haspopup":true,"aria-expanded":false};create(ctx.input,_extends({"aria-controls":resultsList.id,"aria-autocomplete":"both"},placeHolder&&{placeholder:placeHolder},!ctx.wrapper&&_extends({},parentAttrs)));if(ctx.wrapper)ctx.wrapper=create("div",_extends({around:ctx.input,class:ctx.name+"_wrapper"},parentAttrs));if(resultsList)ctx.list=create(resultsList.tag,_extends({dest:[resultsList.destination,resultsList.position],id:resultsList.id,role:"listbox",hidden:"hidden"},resultsList.class&&{class:resultsList.class}));addEvents(ctx);if(ctx.data.cache)yield getData(ctx);eventEmitter("init",ctx);})()}

  function extend(autoComplete){const{prototype}=autoComplete;prototype.init=function(){init(this);};prototype.start=function(query){start(this,query);};prototype.unInit=function(){if(this.wrapper){const parentNode=this.wrapper.parentNode;parentNode.insertBefore(this.input,this.wrapper);parentNode.removeChild(this.wrapper);}removeEvents(this);};prototype.open=function(){open(this);};prototype.close=function(){close(this);};prototype.goTo=function(index){goTo(index,this);};prototype.next=function(){next(this);};prototype.previous=function(){previous(this);};prototype.select=function(index){select(this,null,index);};prototype.search=function(query,record,options){return search(query,record,options)};}

  function autoComplete(config){this.options=config;this.id=autoComplete.instances=(autoComplete.instances||0)+1;this.name="autoComplete";this.wrapper=1;this.threshold=1;this.debounce=0;this.resultsList={position:"afterend",tag:"ul",maxResults:5};this.resultItem={tag:"li"};configure(this);extend.call(this,autoComplete);init(this);}

  return autoComplete;

}));
